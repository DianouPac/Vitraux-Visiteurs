function getTours(a,b){var c=function(a){var b=a.rows[0].key[0],c=a.rows[0].value.name,d=[];a.rows.forEach(function(e){var f=e.key[1],g="",h="";f&&d.indexOf(e.key[1])==-1&&(d.push(e.key[1]),a.rows.forEach(function(a){a.key[1]==f&&a.value.broader&&(h=a.value.broader.id)}),a.rows.forEach(function(a){a.key[1]==f&&a.value.name&&(g=a.value.name)}),$("#courses-num").text(parseInt($("#courses-num").text())+1),courseList.add({id:f,"course-title":'Parcours "'+g+'"',"course-vp":"— "+c,broader_id:h,distance:0,locations:0,locations_name:[],vitraux:[],duration:"NC","items-nb":0,"topic-link":"map.html?viewpoint="+b+"&topic="+f}))})},d=function(a){a.rows.forEach(function(a){if(a.value.topic)for(var b=courseList.get("id",a.value.topic.id)[0];b;)b.values().vitraux.indexOf(a.id)==-1&&(b.values({"items-nb":b.values()["items-nb"]+1}),b.values().vitraux.push(a.id)),b=courseList.get("id",b.values().broader_id)[0]}),a.rows.forEach(function(b){if(b.value.spatial){var c=b.id,d=b.value.spatial;a.rows.forEach(function(a){if(a.value.topic&&a.id==c)for(var b=courseList.get("id",a.value.topic.id)[0];b;)b.values().locations_name.indexOf(d)==-1&&(b.values().locations_name.push(d),b.values({locations:b.values().locations+1})),b=courseList.get("id",b.values().broader_id)[0]})}}),courseList.sort("locations",{order:"desc"})},e=function(){var a={valueNames:["course-title","course-vp","distance","locations","duration","items-nb",{data:["id"]},{attr:"href",name:"topic-link"}],item:'<li class="table-view-cell course" data-id=""><a class="navigate-right topic-link" href="#" data-transition="slide-in" data-ignore="push"><div class="media-body"><div class="course-header"><h2 class="course-title"></h2><p class="course-vp"></p></div><div class="course-abstract clearfix"><div><p><span class="fa fa-flag-o"></span> <span class="distance"></span> km</p><p><span class="fa fa-map-marker"></span> <span class="locations"></span> Lieu(x)</p></div><div><p><span class="fa fa-clock-o"></span> <span class="duration"></span></p><p><span class="items-nb"></span><span class="item-text"><span> Vitraux</p></div></div></div></a></li>'};courseList=new List("courses",a)};e(),Promise.all(a.map(function(a){return requestFactory("http://argos2.hypertopic.org/viewpoint/"+a,c)}).concat(b.map(function(a){return requestFactory(a)}))).then(function(a){a.map(function(a){a&&d(a)})})}function getCourseMap(a){function b(a){function b(c,d){c.forEach(function(c){c.key[1]==d&&c.value.narrower?(j.push(c.value.narrower.id),b(a.rows,c.value.narrower.id)):c.key[1]==j[0]&&c.value.name&&$(".title").text('Parcours "'+c.value.name+'"')})}b(a.rows,j[0])}function c(a){a.map(function(a){var b=[];a.rows.forEach(function(a){a.value.topic&&j.indexOf(a.value.topic.id)!=-1&&b.push(a.id)}),a.rows.forEach(function(a){a.value.spatial&&b.indexOf(a.id)!=-1&&k.indexOf(a.value.spatial)==-1&&k.push(a.value.spatial)})})}function d(a){var b={zoom:14,center:a,mapTypeId:google.maps.MapTypeId.TERRAIN,maxZoom:20};g=new google.maps.Map(document.getElementById("map"),b)}function e(a,b,c){var d={location:a,radius:500,query:b},e=new google.maps.places.PlacesService(c);return new Promise(function(a,c){e.textSearch(d,function(c,d){a(d===google.maps.places.PlacesServiceStatus.OK?{waypoint:{location:c[0].formatted_address,stopover:!0},place:b}:null)})})}function f(a,b){function c(a,b,c){var d=[],e=0,f=a.waypoint_order;a.legs.map(function(a,g){if(d.indexOf(a.end_location.toString())==-1){var i=new google.maps.Marker({position:a.end_location,map:b,label:(g+1).toString()}),k=c[f[g]].place,l=new google.maps.InfoWindow({content:'<a href="explore.html?topic='+j[0]+"&viewpoint="+h+"&spatial="+k+'">'+k+"</a>"});e+=a.duration.value,d.push(a.end_location.toString()),i.addListener("click",function(){l.open(b,i)})}})}var d=new google.maps.DirectionsService,e=new google.maps.DirectionsRenderer({map:b,suppressMarkers:!0}),f=a.map(function(a){return a.waypoint}),g={origin:f[0].location,destination:f[0].location,waypoints:f,travelMode:google.maps.DirectionsTravelMode.WALKING,optimizeWaypoints:!0};return new Promise(function(f,h){d.route(g,function(d,f){f==google.maps.DirectionsStatus.OK&&(e.setDirections(d),c(d.routes[0],b,a))})})}var g,h=getUrlParameter("viewpoint"),i=new google.maps.LatLng(48.2973725,4.0721523),j=[getUrlParameter("topic")],k=[];Promise.all([requestFactory("http://argos2.hypertopic.org/viewpoint/"+h,b)].concat(a.map(function(a){return requestFactory(a)}))).then(function(a){return a=cleanData(a),c(a),d(i),Promise.all(k.map(function(a){return e(i,a,g)}))}).then(function(a){return a=cleanData(a),f(a,g)})}function getLocationVitraux(a,b){function c(a){function b(c,d){c.forEach(function(c){c.key[1]==d&&c.value.narrower?(h.push(c.value.narrower.id),b(a.rows,c.value.narrower.id)):c.key[1]==h[0]&&c.value.name&&$(".title").text('Parcours "'+c.value.name+'"')})}b(a.rows,h[0])}function d(a){a.map(function(a){var b=[];a.rows.forEach(function(a){a.value.topic&&h.indexOf(a.value.topic.id)!=-1&&b.push(a.id)}),a.rows.forEach(function(a){if(b.indexOf(a.id)!=-1&&a.value.spatial&&a.value.spatial==g){var c=a.id,d="description.html?id="+c+"&topic="+h[0]+"&viewpoint="+f+"&spatial="+g,e='<li id="'+c+'" class="table-view-cell"><a class="navigate-right" href="'+d+'" data-transition="slide-in"><div class="stained-glass-desc"><h3 class="stained-glass-name"></h3></div><div class="stained-glass-img"><img class="table-img" src="" ></div></a></li>';$("#stainted-glass-windows").append(e),i.push(a.id)}})})}function e(a){a.rows.forEach(function(a){i.indexOf(a.key[1])!=-1&&(a.value.name?$("#"+a.key[1]).find(".stained-glass-name").text(a.value.name):a.value.thumbnail&&$("#"+a.key[1]).find("img").attr("src",a.value.thumbnail))})}var f=getUrlParameter("viewpoint"),g=decodeURIComponent(getUrlParameter("spatial")),h=[getUrlParameter("topic")],i=[];$("#back").attr("href","map.html?+&viewpoint="+f+"&topic="+h[0]),$(".place-name").text(g),Promise.all([requestFactory("http://argos2.hypertopic.org/viewpoint/"+f,c)].concat(a.map(function(a){return requestFactory(a)}))).then(function(a){return a=cleanData(a),d(a),Promise.all(b.map(function(a){return requestFactory(a,e)}))})}function getVitrailId(){var a=getUrlParameter("id"),b=getUrlParameter("topic"),c=getUrlParameter("viewpoint"),d=getUrlParameter("spatial");$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",dataType:"json",success:function(e){$.each(e.rows,function(e,f){f.value.resource&&f.key[1]===a&&($(".preview-img").attr("src",f.value.resource),$("#found-btn").attr("onclick",'found("'+a+'","'+d+'","'+b+'","'+c+'")'),$("#back").attr("href","explore.html?topic="+b+"&viewpoint="+c+"&spatial="+d)),f.value.name&&f.key[1]===a&&$(".title").text(f.value.name)})}}),localStorage.getItem(a)&&$("#found-btn").text("Description")}function found(a,b,c,d){localStorage.setItem(a,!0),PUSH({url:"description.html?id="+a+"&topic="+c+"&viewpoint="+d+"&spatial="+b,transition:"slide-in"})}function getDescription(){var a=getUrlParameter("id"),b=getUrlParameter("spatial"),c=getUrlParameter("viewpoint"),d=getUrlParameter("topic");$("#back").attr("href","explore.html?topic="+d+"&viewpoint="+c+"&spatial="+b),$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",type:"GET",dataType:"json",success:function(b){var c,d,e;$.each(b.rows,function(b,f){f.key[1]===a&&(f.value.name?c=f.value.name:f.value.thumbnail?d=f.value.thumbnail:f.value.resource&&(e=f.value.resource))}),$(".title").text(c),$("#vitrailModal").find(".title").text(c+" [Zoom]"),$("#vitrailModal").find("a.btn").attr("href",e),$("#vitrail-thumbnail").find("img").attr("src",d),$("#vitrail-thumbnail").find("img").attr("alt",c),$("#vitrail-resource").attr("src",e),$("#vitrail-resource").attr("alt",c)}})}var viewpoints=["56e092d8a6179a788c74b618b29801c0","a76306e4f17ed4f79e7e481eb9a1bd06"],corpusArgos=["http://argos2.hypertopic.org/corpus/Vitraux - Bénel","http://argos2.hypertopic.org/corpus/Vitraux%20-%20Dr.%20Krieger","http://argos2.hypertopic.org/corpus/Vitraux%20-%20Recensement"],corpusSt=["http://steatite.hypertopic.org/corpus/Vitraux - Bénel","http://steatite.hypertopic.org/corpus/Vitraux%20-%20Dr.%20Krieger","http://steatite.hypertopic.org/corpus/Vitraux%20-%20Recensementl"],loading=function(){var a=$("div.content").attr("id");switch(a){case"courses":getTours(viewpoints,corpusArgos);break;case"map-page":getCourseMap(corpusArgos);break;case"explore-page":getLocationVitraux(corpusArgos,corpusSt);break;case"preview-page":getVitrailId();break;case"description-page":getDescription()}},getUrlParameter=function(a){var b,c,d=decodeURIComponent(window.location.search.substring(1)),e=d.split("&");for(c=0;c<e.length;c++)if(b=e[c].split("="),b[0]===a)return void 0===b[1]||b[1]},uniq=function(a){var b={};return a.filter(function(a){return!b.hasOwnProperty(a)&&(b[a]=!0)})},getItemText=function(a,b,c){return 1===a?b:c},cleanData=function(a){return a.filter(function(a){return a})},requestFactory=function(a,b){var c=new Promise(function(c,d){$.ajax({type:"GET",url:a,dataType:"json",success:function(a){c("function"==typeof b?b(a):a)},erreur:function(){d("La requête a échoué")}})});return c};$(document).ready(loading);var google;