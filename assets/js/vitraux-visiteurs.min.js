function requestFactory(a,b){var c=new Promise(function(c,d){$.ajax({type:"GET",url:a,dataType:"json",success:function(a){c("function"==typeof b?b(a):a)},erreur:function(){d("La requête a échoué")}})});return c}function initList(){var a={valueNames:["course-title","course-vp","distance","locations","duration","items-nb",{data:["id"]},{attr:"href",name:"topic-link"}],item:'<li class="table-view-cell course" data-id=""><a class="navigate-right topic-link" href="#" data-transition="slide-in" data-ignore="push"><div class="media-body"><div class="course-header"><h2 class="course-title"></h2><p class="course-vp"></p></div><div class="course-abstract clearfix"><div><p><span class="fa fa-flag-o"></span> <span class="distance"></span> km</p><p><span class="fa fa-map-marker"></span> <span class="locations"></span></p></div><div><p><span class="fa fa-clock-o"></span> <span class="duration"></span></p><p><span class="items-nb"></span><span class="item-text"><span></p></div></div></div></a></li>'};courseList=new List("courses",a)}function getCoursesList(){function a(a){var b=a.rows[0].key[0],c=a.rows[0].value.name,d=[];a.rows.forEach(function(e){var f=e.key[1],g="",h="";f&&d.indexOf(e.key[1])==-1&&(d.push(e.key[1]),a.rows.forEach(function(a){a.key[1]==f&&a.value.broader&&(h=a.value.broader.id)}),a.rows.forEach(function(a){a.key[1]==f&&a.value.name&&(g=a.value.name)}),$("#courses-num").text(parseInt($("#courses-num").text())+1),courseList.add({id:f,"course-title":'Parcours "'+g+'"',"course-vp":"— "+c,broader_id:h,distance:0,locations:0,locations_name:[],duration:0,"items-nb":0,"topic-link":"map.html?viewpoint="+b+"&topic="+f}))})}function b(a){$.each(a.rows,function(a,b){if(b.value.topic){var c=courseList.get("id",b.value.topic.id)[0];"undefined"!=typeof c&&c.values({"items-nb":c.values()["items-nb"]+1})}}),$.each(a.rows,function(b,c){if(c.value.spatial){var d=c.id,e=c.value.spatial;$.each(a.rows,function(a,b){if(b.value.topic&&b.id==d){var c=courseList.get("id",b.value.topic.id)[0];if("undefined"!=typeof c&&c.values().locations_name.indexOf(e)==-1){c.values().locations_name.push(e);c.values({locations:c.values().locations+1})}}})}})}var c=[{id:"56e092d8a6179a788c74b618b29801c0",name:"Histoire des religions"},{id:"a76306e4f17ed4f79e7e481eb9a1bd06",name:"Histoire de l'art"}],d=["http://argos2.hypertopic.org/corpus/Vitraux - Bénel","http://argos2.hypertopic.org/corpus/Vitraux%20-%20Dr.%20Krieger","http://argos2.hypertopic.org/corpus/Vitraux%20-%20Recensement"];Promise.all(c.map(function(b){return requestFactory("http://argos2.hypertopic.org/viewpoint/"+b.id,a)}).concat(d.map(function(a){return requestFactory(a)}))).then(function(a){a.map(function(a){"undefined"!=typeof a&&b(a)})})}function getCourseMap(){function a(a){a.rows.forEach(function(a){a.value.name&&$(".title").text('Parcours "'+a.value.name+'"')})}function b(a){a.rows.forEach(function(a){a.value.topic&&a.value.topic.id==i&&k.push(a.id)}),a.rows.forEach(function(a){a.value.spatial&&k.indexOf(a.id)!=-1&&console.log(a.value.spatial),a.value.spatial&&k.indexOf(a.id)!=-1&&l.indexOf(a.value.spatial)==-1&&l.push(a.value.spatial)}),console.log(l)}function c(a){var b={zoom:14,center:a,mapTypeId:google.maps.MapTypeId.TERRAIN,maxZoom:20};g=new google.maps.Map(document.getElementById("map"),b)}function d(a,b){var c=[],d=new Promise(function(d,e){b.map(function(e){var f={location:a,radius:500,query:e},j=new google.maps.places.PlacesService(g);j.textSearch(f,function(a,f){f===google.maps.places.PlacesServiceStatus.OK&&(c.push({location:a[0].formatted_address,stopover:!0}),console.log(e+"=>"+a[0].formatted_address),m.push({lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng(),location:a[0].formatted_address,url:'<div><a href="explore.html?topic='+i+"&viewpoint="+h+"&spatial="+e+'">'+e+"</a></div>"}),c.length==b.length&&d(c))})})});d.then(function(a){e(a[0].location,a[a.length-1].location,a)})}function e(a,b,c){var d=new google.maps.DirectionsService,e=new google.maps.DirectionsRenderer({map:g,suppressMarkers:!0}),h={origin:a,destination:b,waypoints:c,travelMode:google.maps.DirectionsTravelMode.WALKING,optimizeWaypoints:!0};d.route(h,function(a,b){b===google.maps.DirectionsStatus.OK&&(f(a.routes[0].legs),e.setDirections(a))})}function f(a){var b=0;increment=["A","B","C","D","E","F","G","H"],a.map(function(a,c){m.filter(function(b){return b.location==a.end_address});b+=a.duration.value;var d=new google.maps.Marker({position:a.end_location,map:g,label:increment[c],animation:google.maps.Animation.DROP,title:""});d.addListener("click",function(){info.open(g,d)})}),b=getCourseDuration(b/60),$("#duration").text(b)}var g,h=getUrlParameter("viewpoint"),i=getUrlParameter("topic"),j=new google.maps.LatLng(48.2973725,4.0721523),k=[],l=[],m=[],n=navigator.geolocation,o={};n.getCurrentPosition(function(a){o.lat=a.coords.latitude,o.lng=a.coords.longitude}),Promise.all([requestFactory("http://argos2.hypertopic.org/corpus/Vitraux - Bénel",b),requestFactory("http://argos2.hypertopic.org/topic/"+h+"/"+i,a)]).then(function(){c(j),d(j,l)})}function getLocationVitraux(){function a(a){a.rows.forEach(function(a){if(a.value.item&&"Vitraux - Bénel"===a.value.item.corpus){var b=a.value.item.name,f=a.value.item.id,g=localStorage.getItem(f)?"inline":"none",h=(localStorage.getItem(f)?"description.html":"preview.html")+"?id="+f+"&topic="+d+"&viewpoint="+c+"&spatial="+e,i='<li id="'+f+'" class="table-view-cell"><a class="navigate-right" href="'+h+'" data-transition="slide-in"><div class="stained-glass-desc"><h3 class="stained-glass-name">'+b+'</h3><button style="display:'+g+'" class="btn btn-outlined btn-positive"><span class="fa fa-check"></span> Trouvé</button></div><div class="stained-glass-img"><img class="table-img" src="http://steatite.hypertopic.org/thumbnail/'+f+'" ></div></a></li>';$("#stainted-glass-windows").append(i)}else a.value.name&&$(".title").text('Parcours "'+a.value.name+'"')})}function b(a){a.rows.forEach(function(a){a.value.name&&($("#"+a.key[1]).find(".stained-glass-name").text(a.value.name),$("#"+a.key[1]).find("img").attr("alt",a.value.name))})}if(void 0!==getUrlParameter("viewpoint"))var c=getUrlParameter("viewpoint"),d=getUrlParameter("topic"),e=decodeURIComponent(getUrlParameter("spatial"));$("#back").attr("href","map.html?+&viewpoint="+c+"&topic="+d),$(".place-name").text(e),Promise.all([requestFactory("http://steatite.hypertopic.org/corpus/Vitraux - Bénel",b),requestFactory("http://argos2.hypertopic.org/topic/"+c+"/"+d,a)])}function getVitrailId(){var a=getUrlParameter("id"),b=getUrlParameter("topic"),c=getUrlParameter("viewpoint"),d=getUrlParameter("spatial");$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",dataType:"json",success:function(e){$.each(e.rows,function(e,f){f.value.resource&&f.key[1]===a&&($(".preview-img").attr("src",f.value.resource),$("#found-btn").attr("onclick",'found("'+a+'","'+d+'","'+b+'","'+c+'")'),$("#back").attr("href","explore.html?topic="+b+"&viewpoint="+c+"&spatial="+d)),f.value.name&&f.key[1]===a&&$(".title").text(f.value.name)})}}),localStorage.getItem(a)&&$("#found-btn").text("Description")}function found(a,b,c,d){localStorage.setItem(a,!0),PUSH({url:"description.html?id="+a+"&topic="+c+"&viewpoint="+d+"&spatial="+b,transition:"slide-in"})}function getDescription(){var a=getUrlParameter("id"),b=getUrlParameter("spatial"),c=getUrlParameter("viewpoint"),d=getUrlParameter("topic");$("#back").attr("href","explore.html?topic="+d+"&viewpoint="+c+"&spatial="+b),$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",type:"GET",dataType:"json",success:function(b){var c,d,e;$.each(b.rows,function(b,f){f.key[1]===a&&(f.value.name?c=f.value.name:f.value.thumbnail?d=f.value.thumbnail:f.value.resource&&(e=f.value.resource))}),$(".title").text(c),$("#vitrailModal").find(".title").text(c+" [Zoom]"),$("#vitrailModal").find("a.btn").attr("href",e),$("#vitrail-thumbnail").find("img").attr("src",d),$("#vitrail-thumbnail").find("img").attr("alt",c),$("#vitrail-resource").attr("src",e),$("#vitrail-resource").attr("alt",c)}})}var getUrlParameter=function(a){var b,c,d=decodeURIComponent(window.location.search.substring(1)),e=d.split("&");for(c=0;c<e.length;c++)if(b=e[c].split("="),b[0]===a)return void 0===b[1]||b[1]},uniq=function(a){var b={};return a.filter(function(a){return!b.hasOwnProperty(a)&&(b[a]=!0)})},getItemText=function(a,b,c){return 1===a?b:c},getCourseDuration=function(a){var b=Math.floor(a/60),c=a%60;return 0===b?0===c?"0 min":Math.floor(c)+" min":0===c?b+" h":b+"h"+Math.floor(c)},checkPage=function(){var a=$("div.content").attr("id");switch(a){case"courses":initList(),getCoursesList();break;case"map-page":getCourseMap();break;case"explore-page":getLocationVitraux();break;case"preview-page":getVitrailId();break;case"description-page":getDescription()}};window.addEventListener("push",checkPage),$(document).ready(checkPage);var google;