function requestFactory(a,b){var c=$.ajax({type:"GET",url:a,dataType:"json",success:function(a){b(a)}});return c}function initList(){var a={valueNames:["course-title","course-vp","distance","locations","duration","items-nb",{data:["id"]},{attr:"href",name:"topic-link"}],item:'<li class="table-view-cell course" data-id=""><a class="navigate-right topic-link" href="#" data-transition="slide-in" data-ignore="push"><div class="media-body"><div class="course-header"><h2 class="course-title"></h2><p class="course-vp"></p></div><div class="course-abstract clearfix"><div><p><span class="fa fa-flag-o"></span> <span class="distance"></span> km</p><p><span class="fa fa-map-marker"></span> <span class="locations"></span></p></div><div><p><span class="fa fa-clock-o"></span> <span class="duration"></span></p><p><span class="items-nb"></span><span class="item-text"><span></p></div></div></div></a></li>'};courseList=new List("courses",a)}function getCoursesList(){function a(a){var b=a.rows[0].key[0],c=a.rows[0].value.name;$.each(a.rows,function(a,d){d.value.narrower&&($("#courses-num").text(parseInt($("#courses-num").text())+1),courseList.add({id:d.value.narrower.id,"course-title":'Parcours "'+d.value.narrower.name+'"',"course-vp":"— "+c,distance:0,locations:0,locations_name:[],duration:0,"items-nb":0,"topic-link":"map.html?viewpoint="+b+"&topic="+d.value.narrower.id}))})}function b(a){$.each(a.rows,function(a,b){if(b.value.topic){var c=courseList.get("id",b.value.topic.id)[0];"undefined"!=typeof c&&c.values({"items-nb":c.values()["items-nb"]+1})}}),$.each(a.rows,function(b,c){if(c.value.spatial){var d=c.id,e=c.value.spatial;$.each(a.rows,function(a,b){if(b.value.topic&&b.id==d){var c=courseList.get("id",b.value.topic.id)[0];if("undefined"!=typeof c&&c.values().locations_name.indexOf(e)==-1){c.values().locations_name.push(e);c.values({locations:c.values().locations+1})}}})}})}var c=[{id:"56e092d8a6179a788c74b618b29801c0",name:"Histoire des religions"},{id:"a76306e4f17ed4f79e7e481eb9a1bd06",name:"Histoire de l'art"}],d=["http://argos2.hypertopic.org/corpus/Vitraux - Bénel"];Promise.all(c.map(function(b){return requestFactory("http://argos2.hypertopic.org/viewpoint/"+b.id,a)}).concat(d.map(function(a){return requestFactory(a,b)})))}function getCourseMap(){var a=getUrlParameter("viewpoint"),b=getUrlParameter("topic"),c=[],d=[];$.ajax({url:"http://argos2.hypertopic.org/topic/"+a+"/"+b,dataType:"json",success:function(e){$.each(e.rows,function(a,b){b.value.item?c.push(b.value.item.id):b.value.name&&$(".title").text('Parcours "'+b.value.name+'"')}),$.ajax({url:"http://argos2.hypertopic.org/corpus/Vitraux - Bénel",dataType:"json",success:function(e){$.each(e.rows,function(e,f){if(f.value.spatial&&c.indexOf(f.key[1])!==-1&&d.indexOf(f.value.spatial)===-1){d.push(f.value.spatial),$(".table-view").append('<li class="table-view-cell"><a class="navigate-right" href="explore.html?topic='+b+"&viewpoint="+a+"&spatial="+f.value.spatial+'" data-transition="slide-in">'+f.value.spatial+"</a></li>"),"Église Saint-Remi, Troyes"!==f.value.spatial&&"Église Saint-Remy, Troyes"!==f.value.spatial||(f.value.spatial="3 Place Saint-Remi 10000 Troyes");var g=new google.maps.LatLng(48.2973725,4.0721523),h={location:g,radius:"500",query:f.value.spatial};service=new google.maps.places.PlacesService(map),service.textSearch(h,callback)}})}})}})}function callback(a,b){if(b===google.maps.places.PlacesServiceStatus.OK){var c=a[0];waypoints.push({location:c.formatted_address,stopover:!0}),calculate(waypoints[0].location,waypoints[waypoints.length-1].location,waypoints)}}function initialize(){var a=new google.maps.LatLng(48.2973725,4.0721523),b={zoom:14,center:a,mapTypeId:google.maps.MapTypeId.TERRAIN,maxZoom:20};map=new google.maps.Map(document.getElementById("map"),b),direction=new google.maps.DirectionsRenderer({map:map})}function calculate(a,b,c){var d={origin:a,destination:b,waypoints:c,travelMode:google.maps.DirectionsTravelMode.WALKING},e=new google.maps.DirectionsService;e.route(d,function(a,b){b===google.maps.DirectionsStatus.OK&&direction.setDirections(a)})}function getLocationVitraux(){if(void 0!==getUrlParameter("viewpoint"))var a=getUrlParameter("viewpoint"),b=getUrlParameter("topic"),c=decodeURIComponent(getUrlParameter("spatial"));$("#back").attr("href","map.html?+&viewpoint="+a+"&topic="+b),$(".place-name").text(c),$.ajax({url:"http://argos2.hypertopic.org/topic/"+a+"/"+b,dataType:"json",success:function(d){$.each(d.rows,function(d,e){if(e.value.item&&"Vitraux - Bénel"===e.value.item.corpus){var f="",g="none";e.value.item.name&&"Sans nom"!==e.value.item.name&&(f=e.value.item.name);var h=e.value.item.id,i="preview.html?id="+h+"&topic="+b+"&viewpoint="+a+"&spatial="+c;localStorage.getItem(h)&&(g="inline",i="description.html?id="+h+"&topic="+b+"&viewpoint="+a+"&spatial="+c);var j='<li id="'+h+'" class="table-view-cell"><a class="navigate-right" href="'+i+'" data-transition="slide-in"><div class="stained-glass-desc"><h3 class="stained-glass-name">'+f+'</h3><button style="display:'+g+'" class="btn btn-outlined btn-positive"><span class="fa fa-check"></span> Trouvé</button></div><div class="stained-glass-img"><img class="table-img" src="" alt="'+f+'"></div></a></li>';$("#stainted-glass-windows").append(j)}else e.value.name&&$(".title").text('Parcours "'+e.value.name+'"')})}}),$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",dataType:"json",success:function(a){$.each(a.rows,function(a,b){b.value.thumbnail&&$("#"+b.key[1]).find("img").attr("src",b.value.thumbnail),b.value.name&&($("#"+b.key[1]).find(".stained-glass-name").text(b.value.name),$("#"+b.key[1]).find("img").attr("alt",b.value.name))})}}),$.ajax({url:"http://argos2.hypertopic.org/corpus/Vitraux - Bénel",dataType:"json",success:function(a){$.each(a.rows,function(a,b){if(b.value.spatial&&b.value.spatial!==c){var d=$("#"+b.key[1]);d.length&&d.remove()}});var b=$("#stainted-glass-windows li").length-1;$("#text-info-vitraux1").text(getItemText(b,"le vitrail","les vitraux")),$("#text-info-vitraux2").text(getItemText(b,"le","les"))}})}function getVitrailId(){var a=getUrlParameter("id"),b=getUrlParameter("topic"),c=getUrlParameter("viewpoint"),d=getUrlParameter("spatial");$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",dataType:"json",success:function(e){$.each(e.rows,function(e,f){f.value.resource&&f.key[1]===a&&($(".preview-img").attr("src",f.value.resource),$("#found-btn").attr("onclick",'found("'+a+'","'+d+'","'+b+'","'+c+'")'),$("#back").attr("href","explore.html?topic="+b+"&viewpoint="+c+"&spatial="+d)),f.value.name&&f.key[1]===a&&$(".title").text(f.value.name)})}}),localStorage.getItem(a)&&$("#found-btn").text("Description")}function found(a,b,c,d){localStorage.setItem(a,!0),PUSH({url:"description.html?id="+a+"&topic="+c+"&viewpoint="+d+"&spatial="+b,transition:"slide-in"})}function getDescription(){var a=getUrlParameter("id"),b=getUrlParameter("spatial"),c=getUrlParameter("viewpoint"),d=getUrlParameter("topic");$("#back").attr("href","explore.html?topic="+d+"&viewpoint="+c+"&spatial="+b),$.ajax({url:"http://steatite.hypertopic.org/corpus/Vitraux - Bénel",type:"GET",dataType:"json",success:function(b){var c,d,e;$.each(b.rows,function(b,f){f.key[1]===a&&(f.value.name?c=f.value.name:f.value.thumbnail?d=f.value.thumbnail:f.value.resource&&(e=f.value.resource))}),$(".title").text(c),$("#vitrailModal").find(".title").text(c+" [Zoom]"),$("#vitrailModal").find("a.btn").attr("href",e),$("#vitrail-thumbnail").find("img").attr("src",d),$("#vitrail-thumbnail").find("img").attr("alt",c),$("#vitrail-resource").attr("src",e),$("#vitrail-resource").attr("alt",c)}})}var getUrlParameter=function(a){var b,c,d=decodeURIComponent(window.location.search.substring(1)),e=d.split("&");for(c=0;c<e.length;c++)if(b=e[c].split("="),b[0]===a)return void 0===b[1]||b[1]},uniq=function(a){var b={};return a.filter(function(a){return!b.hasOwnProperty(a)&&(b[a]=!0)})},getItemText=function(a,b,c){return 1===a?b:c},getCourseDuration=function(a){var b=Math.floor(a/60),c=a%60;return 0===b?0===c?"0":c+" min":0===c?b+" h":b+"h"+c},checkPage=function(){var a=$("div.content").attr("id");switch(a){case"courses":initList(),getCoursesList();break;case"map-page":initialize(),getCourseMap();break;case"explore-page":getLocationVitraux();break;case"preview-page":getVitrailId();break;case"description-page":getDescription()}};window.addEventListener("push",checkPage),$(document).ready(checkPage);var google,map,initialize,calculate,direction,waypoints=[];