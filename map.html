<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="icon" href="assets/img/favicon.ico" />

        <link rel="stylesheet" href="bower_components/ratchet/dist/css/ratchet.min.css">
        <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
        <link rel="stylesheet" href="bower_components/roboto-fontface/css/roboto/roboto-fontface.css" />
        <link rel="stylesheet" href="assets/css/main.css">
        <style type="text/css">
            #map{width:100%;height:80%;}
        </style>

    </head>
    <body>
        <header class="bar bar-nav">
            <a class="icon icon-left-nav pull-left" href="courses.html" data-transition="slide-out" data-ignore="push"></a>
            <h1 class="title"></h1>
        </header>
        <div class="content">
            <div id="map">
                <p>Veuillez patienter pendant le chargement de la carte...</p>
            </div>
            <div class="card">
                <ul class="table-view"></ul>
            </div>
        </div>
        <script src="bower_components/jquery/dist/jquery.min.js"></script>
        <script src="bower_components/ratchet/dist/js/ratchet.js"></script>
        <script src="assets/js/map.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?language=fr&libraries=places"></script>

        <script>
            var getUrlParameter = function getUrlParameter(sParam) {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                        sURLVariables = sPageURL.split('&'),
                        sParameterName,
                        i;

                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };
            viewpoint = getUrlParameter('viewpoint');
            topic = getUrlParameter('topic');

            waypoint = [];
            topicids = [];
            initialize();
            $.ajax({
                url: 'http://argos2.hypertopic.org/topic/' + viewpoint + '/' + topic,
                dataType: 'json',
                success: function (data) {
                    $.each(data.rows, function (index, r) {
                        if (r.value.item) {
                            topicids.push(r.value.item.id);
                        } else if (r.value.name) {
                            $('.title').text('Parcours' + ' "' + r.value.name + '"');
                        }
                    });
                    $.ajax({
                        url: 'http://argos2.hypertopic.org/corpus/Vitraux - Bénel',
                        dataType: 'json',
                        success: function (data) {
                            $.each(data.rows, function (index, s) {
                                if (s.value.spatial && topicids.indexOf(s.key[1]) !== -1) {
                                    $('.table-view').append('<li class="table-view-cell"><a class="navigate-right" href="explore.html?topic=' + topic + '&viewpoint=' + viewpoint + '&eglise=' + s.value.spatial + '" data-transition="slide-out" data-ignore="push">' + s.value.spatial + '</a></li>');
                                    if (s.value.spatial === "Église Saint-Remi, Troyes") {
                                        s.value.spatial = "3 Place Saint-Remi 10000 Troyes";
                                    }

                                    var troyes = new google.maps.LatLng(48.2973725, 4.0721523);
                                    var request = {
                                        location: troyes,
                                        radius: '500',
                                        query: s.value.spatial
                                    };
                                    service = new google.maps.places.PlacesService(map);
                                    service.textSearch(request, callback);
                                }
                            });
                        }
                    });
                }
            });
            function callback(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    var place = results[0];
                    waypoint.push({
                        location: place.formatted_address,
                        stopover: true
                    });
                    if (waypoint.length > 2) {
                        calculate(waypoint[0].location, waypoint[waypoint.length - 1].location, waypoint);
                    }
                }
            }
        </script>
    </body>
</html>
